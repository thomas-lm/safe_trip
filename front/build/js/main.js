!function(e){var t={};function n(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(o,i,function(t){return e[t]}.bind(null,i));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/assets/",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);const o="https://nas.le-magourou.fr/safe_trip/mobile/",i="https://rs8081-nas.le-magourou.fr/";function r(e,t,n,o,r){var a=new XMLHttpRequest;a.onreadystatechange=function(){4==this.readyState&&(200==this.status||201==this.status?o(JSON.parse(this.responseText)):r(this.responseText))},a.open(e,i+t,!0);var c="";n&&(c=JSON.stringify(n)),a.send(c)}function a(e,t,n){r("GET",e,void 0,t,function(){console.log("erreur get, nouvelle tentative dans 1.5s"),setTimeout(function(){r("GET",e,void 0,t,n)},1500)})}function c(e,t,n,o){r("POST",e,t,n,function(){console.log("erreur post, nouvelle tentative dans 1.5s"),setTimeout(function(){r("POST",e,t,n,o)},1500)})}const s="current-track",d="history-track";const u=5e3,l=1e3,m=2e3,g=2;var f,v,p,y,b,h,E,w;function I(){void 0!=f&&(navigator.geolocation.clearWatch(f),f=void 0),v=void 0,p=void 0}function B(e,t){var n=L.latLng(e.latitude,e.longitude),o=L.latLng(t.latitude,t.longitude);return n.distanceTo(o)}function T(e){e.sort(function(e,t){return e.time-t.time})}function S(e){var t=3.6*e;return Math.round(t)+" km/h"}function k(e,t,n){O(),y=new L.Map("map-screen",{center:[e,t],zoom:18,zoomControl:!1});let o=new L.TileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{minZoom:10,maxZoom:18,attribution:"© http://openstreetmap.org contributors"});y.doubleClickZoom.disable(),y.addLayer(o),(b=L.marker([e,t])).addTo(y).bindPopup("Current position"),(w=L.control()).onAdd=function(e){return this._div=L.DomUtil.create("div","info"),this.update(0),this._div},w.update=function(){var e=(new Date).getTime(),t=0;h.length>0&&(t=e-h[0].time);var o=0;t>0&&(o=1e3*E/t);var i=0;if(h.length>1){var r=e-h[h.length-2].time;i=1e3*B(h[h.length-1],h[h.length-2])/r}var a=n?"<b>"+n+"</b><br>":"";this._div.innerHTML="<p>"+a+"Vi = "+S(i)+"<br>Vm = "+S(o)+"<br>T = "+function(e){var t=Math.round(e/1e3),n=t%60,o=(t-n)/60,i=o%60,r=(o-i)/60,a="";return r>0&&(a+=r+"h "),i>0&&(a+=i+"min "),0==r&&(a+=n+"s"),a}(t)+"<br>d = "+function(e){var t="",n=Math.round(e)%1e3,o=(Math.round(e)-n)/1e3;return o>0&&(t+=o+"km "),t+=n+"m"}(E)+"</p>"},w.addTo(y);var i=function(){w&&(w.update(),setTimeout(i,1e3))};i()}function O(){h=[],E=0,b&&(b.remove(),b=void 0),w&&(w.remove(),w=void 0),y&&(y.eachLayer(function(e){e.remove()}),y.remove(),y=void 0)}function x(e,t){var n;void 0==t&&(t=(new Date).getTime());var o=0;h.length>0&&(o=B(e,n=h[h.length-1])),o>0&&(E+=o,L.polyline([[e.latitude,e.longitude],[n.latitude,n.longitude]],{color:"red"}).addTo(y)),function(e,t,n){b&&b.setLatLng([e,t]),y.panTo(new L.LatLng(e,t)),h.push({latitude:e,longitude:t,time:n})}(e.latitude,e.longitude,t)}function M(e){for(var t,n=[],o=0,i=0;i<e.length;i++){var r=e[i],a=0;n.length>0&&(a=B(r,t=n[n.length-1])),a>0&&(o+=a,L.polyline([[r.latitude,r.longitude],[t.latitude,t.longitude]],{color:"blue"}).addTo(y)),n.push(r)}T(n),h=n.concat(h),E+=o}n.d(t,"initApp",function(){return H});const P="?view=";var _,A,D,j;function J(){I(),_="idle",D=[],j=void 0,O(),document.getElementById("start-screen").classList.remove("open"),document.getElementById("wellcome-screen").classList.remove("open"),document.getElementById("map-screen").classList.remove("open"),document.getElementById("btn-private").classList.add("active"),document.getElementById("btn-public").classList.remove("active"),document.getElementById("btn-start").setAttribute("disabled","disabled"),document.getElementById("btn-start").value="Start",document.getElementById("btn-stop").classList.remove("active"),document.getElementById("in-name").value="",document.getElementById("in-url-share").value=""}function N(e){a("track/"+e,function(t){if(t.respt){var n=t.respt;if(n.records.length>0){T(n.records),k(n.records[n.records.length-1].latitude,n.records[n.records.length-1].longitude,n.name),document.getElementById("map-screen").classList.add("open"),M(t.respt.records);var o=n.records[n.records.length-1].time;setTimeout(function(){!function e(t,n){a("records/"+t+"/"+n,function(o){o.records&&(T(o.records),o.records.forEach(e=>{x(e),n=e.time})),setTimeout(function(){e(t,n)},4e3)},function(){setTimeout(function(){e(t,n)},4e3)})}(e,o)},2500)}else alert("user not have been started currently")}else alert("unknown track")},function(e){alert("unknown track")})}function C(e){A.classList.add("active"),D=[],_="wait",function(e,t){navigator.geolocation?(I(),f=navigator.geolocation.watchPosition(function(t){void 0==f&&console.log("geolocalisation might not be stop correctly");var n=(new Date).getTime(),o=!0;v&&(n-v<m?o=!1:B(t.coords,p)<g&&(o=!1)),o&&(v=n,p=t.coords,e(t.coords))},function(e){1==e.code?t("Error: GPS Access is denied!"):2==e.code&&t("Error: Position is unavailable!")},{enableHighAccuracy:!0,timeout:u,maximumAge:l})):t("geolocalisation not supported")}(function(t){"wait"==_&&(_="intrip",k(t.latitude,t.longitude,j.name),A.classList.remove("active"),document.getElementById("map-screen").classList.add("open"),document.getElementById("start-screen").classList.remove("open"),document.getElementById("wellcome-screen").classList.remove("open"),document.getElementById("btn-stop").classList.add("active"),e()),"intrip"==_&&function(e){var t=(new Date).getTime(),n={time:t,latitude:e.latitude,longitude:e.longitude};if(x(e,t),D.push(n),j){var o={records:D};c("records/"+j.id+"/"+j.editkey,o,function(e){D=[]},function(e){})}else console.log("pas de track, positions non envoyées")}(t)},function(e){alert(e),I()})}function R(){!function(e){if(e){var t=[],n=window.localStorage.getItem(d);n&&(t=JSON.parse(n)),t.push(e),window.localStorage.setItem(d,JSON.stringify(t))}}(j),window.localStorage.removeItem(s),J()}function z(){a("newTrack/"+(new Date).getTime(),function(e){j=e,document.getElementById("in-url-share").value=o+P+j.id,document.getElementById("btn-start").removeAttribute("disabled")},function(e){j=void 0,document.getElementById("btn-start").value="Start offline",document.getElementById("btn-start").removeAttribute("disabled")})}function G(){j&&(j.name=document.getElementById("in-name").value,j.public=document.getElementById("btn-public").classList.contains("active"),c("track",j,function(e){!function(e){e&&window.localStorage.setItem(s,JSON.stringify(e))}(j)},function(e){console.log("SAVE ERROR")}))}function H(){_="idle",J(),document.getElementById("btn-newtrip").addEventListener("click",function(){document.getElementById("start-screen").classList.contains("open")||(document.getElementById("start-screen").classList.add("open"),document.getElementById("wellcome-screen").classList.add("open"),z())});var e=document.getElementById("btn-public"),t=document.getElementById("btn-private");e.addEventListener("click",function(){e.classList.toggle("active"),t.classList.toggle("active")}),t.addEventListener("click",function(){e.classList.toggle("active"),t.classList.toggle("active")}),document.getElementById("btn-start").addEventListener("click",function(){G(),C(function(){})}),document.getElementById("btn-stop").addEventListener("click",function(){R()}),document.getElementById("btn-share").addEventListener("click",function(){navigator&&navigator.share&&navigator.share(document.getElementById("in-url-share").value,"share my trip","plain/text")}),A=document.getElementById("loader");var n=window.location.href.indexOf(P);if(-1!=n)N(window.location.href.substring(n+P.length));else{var o=function(){var e=window.localStorage.getItem(s);if(e)return JSON.parse(e)}();o&&confirm("last session was not finished. Do you want to retrieve it ?")&&(A.classList.add("active"),j=o,C(function(){!function(e){a("track/"+e,function(e){e.respt&&M(e.respt.records)},function(e){})}(j.id)}))}}document.addEventListener("DOMContentLoaded",function(e){H()})}]);